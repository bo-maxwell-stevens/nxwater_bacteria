---
title: "PICRUSt2"
author: "Heather Deel"
date: "2023-10-20"
output: html_document
---

### Getting PICRUSt2 functions for Density/Diversity analysis

### Setup and libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(emmeans)
library(ggplot2)
library(ggthemes)
library(multcomp)
library(phyloseq)
library(RColorBrewer)
library(readxl)
library(tidyverse)
library(microbiomeMarker)
```

```{r setup, echo=FALSE}
source("myFunctions.R")
```

### Convert taxa Relative Abundances to PICRUSt2 GIBBs Relative Abundances
```{r}
# Create GIBBs relative abundances for RhizoDD1
EC.gibbs.info <- read.csv('GIBBs.EC.numbers.csv')
EC.gibbs <- read.csv('EMU_database.GIBBs.EC.PICRUSt2.R.csv')

row.names(EC.gibbs) <- EC.gibbs$tax_id
EC.gibbs <- EC.gibbs[,2:34]

df <- read.csv('EMU.rel_abund.finalRhizoDD1.csv')
df <- df[,2:102]

EC.sub <- EC.gibbs
EC.bin <- EC.sub %>% 
  mutate_if(is.numeric, ~1 * (. > 0))

samples <- names(df)[9:length(names(df))]
enzymes <- names(EC.sub)[11:length(names(EC.sub))]
reads <- colSums(df[,samples], na.rm=T)

final <- data.frame(matrix(ncol = length(samples), nrow = length(enzymes)))
names(final) <- samples
row.names(final) <- enzymes
for (i in samples) {
  for (j in enzymes) {
    value <- sum(df[,i] / EC.bin$X16S_rRNA_Count_1 * EC.bin[,j], na.rm=T) / reads[i]
    final[j,i] <- value
  }
}
write.csv(final, 'GIBBs.rel_abund.final.A.csv')

# Create GIBBs relative abundances for RhizoDD2
df <- read.csv('EMU.rel_abund.finalRhizoDD2.csv')
df <- df[,2:102]

EC.sub <- EC.gibbs
EC.bin <- EC.sub %>% 
  mutate_if(is.numeric, ~1 * (. > 0))

samples <- names(df)[9:length(names(df))]
enzymes <- names(EC.sub)[11:length(names(EC.sub))]
reads <- colSums(df[,samples], na.rm=T)

final <- data.frame(matrix(ncol = length(samples), nrow = length(enzymes)))
names(final) <- samples
row.names(final) <- enzymes
for (i in samples) {
  for (j in enzymes) {
    value <- sum(df[,i] / EC.bin$X16S_rRNA_Count_1 * EC.bin[,j], na.rm=T) / reads[i]
    final[j,i] <- value
  }
}
write.csv(final, 'GIBBs.rel_abund.final.B.csv')
```

### Import data into a phyloseq object
```{r}
# use custom emu_to_phyloseq function to create phyloseq object
P.A <- gibbs_to_phyloseq_EC(RA_file='GIBBs.rel_abund.final.A.csv',
                       meta_file='demultiplex_Rhizo_DD1.xlsx', 
                       sheet = "Rhizo1", range='A1:S97',
                       sample_names='name',
                       run_name='Rhizo1')

P.B <- gibbs_to_phyloseq_EC(RA_file='GIBBs.rel_abund.final.B.csv',
                       meta_file='demultiplex_Rhizo_DD2.xlsx', 
                       sheet = "Rhizo2", range='A1:S92',
                       sample_names='name',
                       run_name='Rhizo2')

# merge all imported datasets
P.rel <- merge_phyloseq(P.A, P.B)
P.rel <- subset_samples(P.rel, Type == 'Soil')
P.rel <- subset_samples(P.rel, final >= 10000)

# save combined relative abundance phyloseq object
saveRDS(P.rel, 'P.rel.GIBBs.RDS')

P.count <- P.rel
for (n in 1:nsamples(P.count)) {
  otu_table(P.count)[,n] <- round(otu_table(P.count)[,n] * sample_data(P.count)$final[n], 0)
}

# don't see that we have qPCR data, so will work with P.count
# save combined count phyloseq object
saveRDS(P.count, 'P.count.GIBBs.RDS')
```

### Differential abundance on picrust2 data
# Between varieties, densities, mono/polyculture
# Density and mono/polyculture comparisons are overall and within variety
# Also compared monoculture between varieties

# Variety comparisons
```{r}
# make the enzyme name the "species", force the other columns to be a rank so microbiomeMarker will run
colnames(tax_table(P.count)) <- c('Kingdom', 'Species', 'Phylum')

Alf_Brass <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("A", "B"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# no marker identified

Alf_Fes <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("A", "F"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# no marker identified

Brass_Fes <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("B", "F"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# no marker identified
```

# Density comparisons
```{r}
D1_24 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X24"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

D1_48 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X48"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

D24_48 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X24", "X48"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# one marker identified
mm1 = data.frame(marker_table(D24_48))
mm1$comparison = "D24vs48"
```

# Mono/polyculture comparisons
```{r}
D1_2 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X2"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

D1_3 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X3"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

D1_2or3 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "X1Plant",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("One", "Other1"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified
```

# Within variety density comparisons
```{r}
Alf1_24 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density_Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("A1", "A24"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Alf1_48 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density_Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("A1", "A48"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Brass1_24 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density_Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("B1", "B24"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Brass1_48 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density_Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("B1", "B48"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Fes1_24 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density_Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("F1", "F24"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Fes1_48 <- microbiomeMarker::run_deseq2(
           P.count, 
           group = "Density_Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("F1", "F48"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified
```

# Within variety mono/polyculture comparisons
```{r}
P.countRAlfalfa <- subset_samples(P.count, Alfalfa == 'Alfalfa')

Alf1_2 <- microbiomeMarker::run_deseq2(
           P.countRAlfalfa, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X2"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Alf1_3 <- microbiomeMarker::run_deseq2(
           P.countRAlfalfa, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X3"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

P.countRBrassica <- subset_samples(P.count, Brassica == 'Brassica')

Brass1_2 <- microbiomeMarker::run_deseq2(
           P.countRBrassica, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X2"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Brass1_3 <- microbiomeMarker::run_deseq2(
           P.countRBrassica, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X3"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

P.countRFescue <- subset_samples(P.count, Fescue == 'Fescue')

Fes1_2 <- microbiomeMarker::run_deseq2(
           P.countRFescue, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X2"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

Fes1_3 <- microbiomeMarker::run_deseq2(
           P.countRFescue, 
           group = "number_plant_types",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("X1", "X3"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified
```

# Between variety monoculture comparisons
```{r}
P.countRMono <- subset_samples(P.count, number_plant_types == '1')

AB_m <- microbiomeMarker::run_deseq2(
           P.countRMono, 
           group = "Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("A", "B"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# one marker identified
mm2 = data.frame(marker_table(AB_m))
mm2$comparison = "Alfalfa_Brassica_Mono"

AF_m <- microbiomeMarker::run_deseq2(
           P.countRMono, 
           group = "Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("A", "F"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified

FB_m <- microbiomeMarker::run_deseq2(
           P.countRMono, 
           group = "Diversity",
           taxa_rank = "Species",
           norm = "RLE", # relative log expression
           transform = "identity", # no transform, option: "log10", "log10p"
           contrast = c("F", "B"),
           p_adjust = "BH", # options are none, bonferroni, BH etc
           pvalue_cutoff = 0.01,
           fitType = "local")
# No marker identified
```

# No markers identified in all but 2 comparisons, and for each of those, only on marker was identified



